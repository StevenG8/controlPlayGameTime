## Context

当前系统以命令行方式运行，`start` 命令进入循环并通过日志输出告警。现状存在两个问题：
- 程序不会在 Windows 启动后自动运行，容易因忘记手动启动导致当天无控制能力。
- 警告信息仅写日志，用户在不看终端时无法及时感知。

基于 proposal，本次设计目标是：
- 在 Windows 启动后以后台模式持续运行控制器。
- 在到达警告时间点时弹窗提醒用户。
- 每个警告时间点只弹窗一次，避免每 5 秒轮询时重复打扰。
- 不新增告警配置定制能力，沿用现有阈值含义。

## Goals / Non-Goals

**Goals:**
- 提供可安装的开机自启能力，使控制器在用户登录后自动启动。
- 引入桌面弹窗通知通道，用于首个警告点、最终警告点和超限提示。
- 建立“单日单阈值一次性弹窗”机制，并在每日重置后自动恢复可提醒状态。
- 保留现有日志审计行为，弹窗与日志并行。

**Non-Goals:**
- 不引入新的告警配置字段（如可调频率、可调文案、可关闭某一级告警）。
- 不实现托盘 GUI、通知中心历史、交互式确认等 UI 功能。
- 不在本次变更中扩展 Linux/macOS 自启动方案。

## Decisions

### 1. 自启动采用 Windows Task Scheduler，而非启动目录快捷方式

**Decision**
- 增加自启动安装/卸载入口（如 `install-autostart` / `remove-autostart`），内部调用 `schtasks` 创建登录触发任务，执行 `game-control start --background`。

**Rationale**
- 任务计划程序可控性更高（任务名、触发器、可审计、可更新）。
- 比启动目录快捷方式更稳定，便于后续升级和故障排查。

**Alternatives Considered**
- 启动目录快捷方式：实现简单，但可观测性与可维护性较弱。
- 注册表 Run 键：实现简单，但变更管理与排障体验一般。

### 2. 后台运行通过新增 `--background` 模式，并保持单实例

**Decision**
- `start` 支持后台模式，抑制交互输出，仅保留日志和弹窗。
- 启动时通过命名锁（lock file 或 OS 互斥体）保证单实例，避免自启动与手动启动并发。

**Rationale**
- 与现有命令结构兼容，改动集中在启动入口和控制循环。
- 单实例可防止重复计时、重复终止进程和重复弹窗。

**Alternatives Considered**
- 独立 Windows Service：更“系统级”，但实现和部署复杂度显著更高。
- 允许多实例：实现简单，但会产生状态竞争与重复告警。

### 3. 弹窗通知抽象为 `Notifier` 接口，默认 Windows 实现

**Decision**
- 新增通知抽象层，例如：
  - `NotifyFirstWarning(remainingMinutes int)`
  - `NotifyFinalWarning(remainingMinutes int)`
  - `NotifyLimitExceeded()`
- Windows 默认实现使用系统命令（PowerShell/原生命令）触发桌面弹窗；失败时记录错误日志。

**Rationale**
- 将通知与控制逻辑解耦，便于测试与后续替换实现。
- 保持依赖最小化，不强制引入重量级 GUI 库。

**Alternatives Considered**
- 直接在控制器里拼接命令：耦合高、难测。
- 引入第三方通知库：开发快，但增加外部依赖与兼容风险。

### 4. 阈值弹窗去重采用“当日阈值标记”并持久化到状态文件

**Decision**
- 在 `QuotaState` 增加当日弹窗状态（如 `FirstWarned`, `FinalWarned`, `LimitWarned` 或等价位图）。
- 触发规则：
  - 首警告条件满足且 `FirstWarned=false` 时弹窗并置位。
  - 末警告条件满足且 `FinalWarned=false` 时弹窗并置位。
  - 超限条件满足且 `LimitWarned=false` 时弹窗并置位。
- 每日重置时清空上述标记。

**Rationale**
- 直接解决“每到警告时间只弹一次”的需求。
- 标记持久化可覆盖进程重启场景，避免重启后重复提醒同一阈值。

**Alternatives Considered**
- 仅内存去重：实现快，但重启后会重复弹窗。
- 基于最近弹窗时间窗口（例如 10 分钟内不重复）：不能严格保证“每阈值仅一次”。

## Risks / Trade-offs

- [Windows 弹窗命令在部分环境不可用] -> 启动时做能力探测；失败时降级为日志并记录一次错误。
- [任务计划程序创建失败（权限/策略限制）] -> 输出明确错误与修复建议，保留手动 `start` 路径。
- [单实例锁实现不当导致“假死实例”] -> 使用带进程信息的锁文件并在启动时清理陈旧锁。
- [状态文件结构变更引发兼容问题] -> 新增字段采用向后兼容默认值，读取旧状态时自动补齐。
- [弹窗可能打断用户体验] -> 严格执行“每阈值每日一次”，避免轮询重复提醒。

## Migration Plan

1. 扩展 CLI：
- 增加自启动安装/卸载命令。
- 为 `start` 增加后台运行参数。

2. 引入通知模块并接入控制器：
- 在阈值判断分支调用通知接口。
- 保持原日志输出。

3. 扩展 `QuotaState`：
- 增加阈值弹窗去重字段。
- 在 `Reset()` 中清空去重状态。

4. 发布与回滚：
- 发布后用户执行一次自启动安装命令。
- 若异常，先卸载自启动任务并回退到手动 `start`。
- 回滚不影响既有核心限时逻辑。

## Open Questions

- 弹窗标题与正文是否需要统一文案规范（当前可先使用固定中文文案）？
- 超限弹窗是否也必须“每日仅一次”（设计默认是）？
- 自启动触发时机是否限定“用户登录后”，还是需要“系统启动后（无登录）”场景？
