## 背景

这是一个全新的 Go 命令行工具项目，旨在帮助用户管理游戏时间，防止过度沉迷。项目目前处于初始化阶段，需要在 Windows 系统上运行，通过监控进程、强制终止和配额管理来实现游戏时间控制。

**约束条件：**
- 使用标准 Go 库，最小化外部依赖
- 需要管理员权限来终止其他进程
- 支持配置文件持久化（JSON/YAML）
- 单用户使用场景，不需要多用户管理
- 日志记录用于审计和调试

## 目标 / 非目标

**目标：**
- 实现可靠的游戏进程检测和终止功能
- 提供精确的游戏时间跟踪和配额管理
- 支持灵活的配置和警告机制
- 实现简单的命令行界面（CLI）
- 确保跨重启的状态持久化
- 支持 Windows 系统

**非目标：**
- 不支持 Linux 系统
- 不提供图形用户界面（GUI）
- 不支持多用户管理或家长控制模式
- 不提供游戏内集成或插件
- 不支持网络远程管理

## 技术决策

### 1. 配置格式：YAML 而非 JSON

**决策**：使用 YAML 作为配置文件格式。

**理由**：
- YAML 更易读，适合手动编辑
- 支持注释，方便用户了解配置选项
- Go 的 YAML 库（gopkg.in/yaml.v3）成熟稳定

**替代方案**：JSON - 更严格但可读性较差，不适合手动编辑

### 2. 进程监控：轮询而非事件监听

**决策**：使用定时轮询（每 5 秒）来检测进程状态。

**理由**：
- 实现简单，不依赖操作系统特定 API
- 跨平台兼容性好
- 5 秒延迟对于游戏时间控制是可接受的

**替代方案**：使用 inotify 或系统进程事件监听 - 更复杂且平台相关性强

### 3. 状态持久化：本地文件而非数据库

**决策**：使用本地 JSON 文件存储配额状态。

**理由**：
- 无需额外依赖，使用标准库 encoding/json
- 数据量小，不需要数据库的复杂功能
- 易于备份和迁移

**替代方案**：SQLite - 引入额外依赖，过度设计

### 4. 定时重置：基于时钟而非 cron

**决策**：在主循环中检查当前时间与重置时间。

**理由**：
- 不依赖外部 cron 服务
- 更容易控制重置逻辑
- 避免系统 cron 配置复杂性

**替代方案**：使用系统 cron - 增加部署复杂度

### 5. 日志格式：结构化 JSON 日志

**决策**：使用结构化 JSON 日志格式。

**理由**：
- 易于机器解析和分析
- Go 标准库支持良好
- 便于后续集成日志聚合工具

**替代方案**：纯文本日志 - 更易读但难以解析

## 风险 / 权衡

| 风险 | 缓解措施 |
|------|----------|
| **进程终止失败** | 添加重试机制，记录失败日志，向用户显示警告 |
| **权限不足** | 启动时检查权限，提供清晰的错误提示 |
| **配置文件损坏** | 验证配置结构，使用默认值作为后备 |
| **时区问题** | 使用本地时区，在配置中明确指定 |
| **进程误判** | 支持精确匹配和可配置名单，用户可自定义 |
| **状态文件丢失** | 定期备份，启动时验证状态文件完整性 |
| **多游戏同时运行** | 同一时间多个游戏进程只计算一次时间 |

## 迁移计划

由于这是全新项目，不需要迁移计划。

**部署步骤：**
1. 编译 Go 二进制文件 (game-control.exe)
2. 复制到 `%USERPROFILE%\AppData\Local\game-control\` 或用户自定义目录
3. 创建配置文件目录（如 `%USERPROFILE%\.config\game-control\`）
4. 创建默认配置文件
5. 配置 Windows 任务计划程序（可选，用于后台运行）

**回滚策略：**
- 删除二进制文件和配置目录
- 删除 Windows 任务计划程序中的任务
- 无需其他回滚操作

## 待解决问题

1. **精确的进程匹配**：如何避免误杀非游戏进程？（当前计划：使用精确进程名单）
2. **游戏启动拦截**：如何在进程启动前拦截？（当前计划：快速轮询检测）
3. **警告通知方式**：如何向用户显示警告？（当前计划：终端输出，后续可考虑桌面通知）
4. **性能影响**：频繁轮询对系统性能的影响？（当前计划：5 秒间隔，后续可优化）